---
sidebarTitle: "ë³‘ì› ìš© ë©”ì‹ ì € ì•±"
---

import { FileTree } from 'nextra/components'

# Sentinel-AI Messenger

ë³¸ í”„ë¡œì íŠ¸ëŠ” ë‹¨ì¼ ë³‘ì›ì„ ëŒ€ìƒìœ¼ë¡œ í•œ íŒŒì¼ëŸ¿ ë‹¨ê³„ë¡œ ì‹œì‘ë˜ì—ˆìœ¼ë©°,<br />
ì´ˆê¸° ë‹¨ê³„ì—ì„œëŠ” ë³´ì•ˆ ê·œì œ ì¤€ìˆ˜ë³´ë‹¤ 'ë©”ì‹œì§€ ì „ë‹¬ì˜ ì‹ ë¢°ì„±'ê³¼ 'ê³µìœ  PC í™˜ê²½ì—ì„œì˜ ì‹ë³„ ì‹œìŠ¤í…œ ìµœì í™”'ë¥¼<br />
ìµœìš°ì„  ëª©í‘œë¡œ ì„¤ì •í•˜ì—¬ ê°œë°œë˜ì—ˆìŠµë‹ˆë‹¤.

## 1. ì—…ë¬´ ê°œìš”

- ì—­í• : í’€ìŠ¤íƒ ê°œë°œ
- ê¸°ìˆ  ìŠ¤íƒ: React, Fastify, BullMQ, Redis, Electron, PostgreSQL, AWS
- ì—…ë¬´ ëª©í‘œ:
  - "PC-Centric" ì‹ë³„ ì²´ê³„ í™•ë¦½ (ì‚¬ìš©ì ê¸°ë°˜ì´ ì•„ë‹Œ í™˜ê²½)
  - í™•ì¥ì„±ì„ ê³ ë ¤í•œ "í”ŒëŸ¬ê·¸í˜•" ì•„í‚¤í…ì²˜
  - ì‹¤ì‹œê°„ ëŒ€í™” ê°€ëŠ¥í•œ í”„ë¡œì„¸ìŠ¤ êµ¬ì¡° êµ¬ì¶•

## 2. í´ë” êµ¬ì¡°
 ```
 messaging/
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ fe/             # Frontend
â”‚   â”œâ”€â”€ desktop/        # Electron
â”‚   â”œâ”€â”€ be/             # Backend API Server
â”‚   â””â”€â”€ ws/             # WebSocket Server
â”œâ”€â”€ infra/              # Deployment
â””â”€â”€ packages/
    â”œâ”€â”€ application/     # Use Cases (Business Logic)
    â”œâ”€â”€ domain/          # Domain Models & Entities
    â”œâ”€â”€ infrastructure/  # External Dependencies (DB, Queue, etc.)
    â”œâ”€â”€ db/              # Prisma Schema & Migrations
    â”œâ”€â”€ di/              # Dependency Injection Container
    â””â”€â”€ shared/          # Shared Types & Constants
 ```
- **í”„ë¡œì íŠ¸ êµ¬ì¡° ê°œìš”**
  - pnpm workspaceë¥¼ í™œìš©í•œ ëª¨ë…¸ë ˆí¬ êµ¬ì¡°
  - ê³„ì¸µí˜• ì•„í‚¤í…ì²˜ë¡œ ê´€ì‹¬ì‚¬ ë¶„ë¦¬ (Domain, Application, Infrastructure)
  - ê³µí†µ ë¡œì§ íŒ¨í‚¤ì§€í™”ë¡œ ì½”ë“œ ì¬ì‚¬ìš©ì„± ê·¹ëŒ€í™”

## 3. ê¸°ìˆ  ì •ë¦¬

### 3-1. Frontend

í”„ë¡ íŠ¸ì—”ë“œ ì„¤ê³„ì˜ í•µì‹¬ ëª©í‘œëŠ” **"ì €ì‚¬ì–‘ PC í™˜ê²½ì—ì„œë„ ì ìœ ìœ¨ì„ ìµœì†Œí™”í•˜ë©° ì‹¤ì‹œê°„ ë©”ì‹ ì €ì˜ ë°˜ì‘ì„±ì„ ê·¹ëŒ€í™”í•˜ëŠ” ê²ƒ"** ì´ì—ˆìŠµë‹ˆë‹¤.

#### High-Performance UX Engineering
- **Zero-Runtime CSS-in-JS (Vanilla Extract)** <br />ë©”ì‹ ì € íŠ¹ì„±ìƒ ìˆ˜ë§ì€ ë©”ì‹œì§€ ë²„ë¸”ì´ ì‹¤ì‹œê°„ìœ¼ë¡œ ìƒì„±ë˜ê³  ìŠ¤í¬ë¡¤ë©ë‹ˆë‹¤. ëŸ°íƒ€ì„ì— ìŠ¤íƒ€ì¼ì„ ê³„ì‚°í•˜ëŠ” ê¸°ì¡´ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” ëŒ€ê·œëª¨ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ ì‹œ CPU ë¶€í•˜ë¥¼ ìœ ë°œí•  ìˆ˜ ìˆì–´ ì´ë¥¼ ë°°ì œí–ˆìŠµë‹ˆë‹¤.
  - Runtime Overhead ì œê±°: ë¹Œë“œ íƒ€ì„ì— ëª¨ë“  ìŠ¤íƒ€ì¼ì„ ì •ì  CSSë¡œ ì¶”ì¶œí•˜ì—¬, ë¸Œë¼ìš°ì €ê°€ ìŠ¤íƒ€ì¼ì„ ê³„ì‚°í•˜ëŠ” Scripting Timeì„ 0ì— ê°€ê¹ê²Œ ë‹¨ì¶•í–ˆìŠµë‹ˆë‹¤.
  - ì„±ëŠ¥ì  ì´ì : ë¹ˆë²ˆí•œ UI ì—…ë°ì´íŠ¸ ìƒí™©ì—ì„œë„ Frame Dropì„ ë°©ì§€í•˜ì—¬ ë§¤ë„ëŸ¬ìš´ ìŠ¤í¬ë¡¤ ê²½í—˜ì„ ì œê³µí•©ë‹ˆë‹¤.
  - Type-Safe Styling: TypeScript ê¸°ë°˜ ìŠ¤íƒ€ì¼ ì •ì˜ë¥¼ í†µí•´ ëŸ°íƒ€ì„ ì—ëŸ¬ë¥¼ ë°©ì§€í•˜ê³  ê°œë°œ ìƒì‚°ì„±ì„ ë†’ì˜€ìŠµë‹ˆë‹¤.
- **ë°ì´í„° ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ ë° ì²´ê° ì†ë„ ìµœì í™”** <br />ë„¤íŠ¸ì›Œí¬ ì§€ì—°ì„ ê¸°ìˆ ì ìœ¼ë¡œ ê·¹ë³µí•˜ì—¬ ì‚¬ìš©ìê°€ 'ê¸°ë‹¤ë¦¼'ì„ ëŠë¼ì§€ ì•Šê²Œ í•˜ëŠ” ì „ëµì„ ë„ì…í–ˆìŠµë‹ˆë‹¤.
  - Optimistic Updates (ë‚™ê´€ì  ì—…ë°ì´íŠ¸): ë©”ì‹œì§€ ì „ì†¡ ì‹œ ì„œë²„ ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ì§€ ì•Šê³  UIë¥¼ ì¦‰ì‹œ ë°˜ì˜í•˜ì—¬ ë„¤íŠ¸ì›Œí¬ ì§€ì—°ì„ 0ìœ¼ë¡œ ì²´ê°í•˜ê²Œ ì„¤ê³„í–ˆìŠµë‹ˆë‹¤.
  - Windowing ê¸°ë²•: ìˆ˜ì²œ ê°œì˜ ë©”ì‹œì§€ ì¤‘ í˜„ì¬ ë³´ì´ëŠ” ì˜ì—­ë§Œ ë Œë”ë§í•˜ë„ë¡ ì²˜ë¦¬í•˜ì—¬ ë¸Œë¼ìš°ì € ë©”ëª¨ë¦¬ ì ìœ ìœ¨ì„ ì¼ì •í•˜ê²Œ ìœ ì§€í–ˆìŠµë‹ˆë‹¤.
- **ë¦¬ì†ŒìŠ¤ ì ìœ  ìµœì í™”: ì €ì‚¬ì–‘ ë° ìƒì£¼í˜• í™˜ê²½ ëŒ€ì‘** <br />ë³‘ì› PC íŠ¹ì„±ìƒ ì œí•œëœ ìì› ë‚´ì—ì„œ ì•ˆì •ì ìœ¼ë¡œ ì•±ì´ ëŒì•„ê°ˆ ìˆ˜ ìˆê²Œ Electronì˜ êµ¬ì¡°ë¥¼ ì„¤ê³„ í–ˆìŠµë‹ˆë‹¤.
  - Single-Socket Architecture (Main Process ê´€ë¦¬): ë©€í‹° ìœˆë„ìš° í™˜ê²½ì—ì„œ ê° ë Œë”ëŸ¬(ì±„íŒ…ì°½, ì„¤ì •ì°½ ë“±)ì— ê°ê° ì†Œì¼“ì„ ì—°ê²°í•  ê²½ìš° ë¶ˆí•„ìš”í•œ PC ìì› ë‚­ë¹„ë¥¼ ì´ˆë˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  ì´ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ì—°ê²° ì£¼ì²´ë¥¼ ë Œë”ëŸ¬ê°€ ì•„ë‹Œ Main Processë¡œ ë‹¨ì¼í™” í•˜ê³ , ë¡œì§ì„ ë‹¨ìˆœí™”í•˜ì—¬ ë³µêµ¬ ë¡œì§ ë° ì£¼ìš” ì†Œì¼“ ë¡œì§ì„ ì¼ì›í™” í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.
  - IPC ì§€ì—° í•´ì†Œ ë° ì§ë ¬í™” ë¹„ìš© ìµœì í™”: IPC í˜ì´ë¡œë“œë¥¼ ìµœì†Œí™” í•˜ê¸° ìœ„í•´ **ID ê¸°ë°˜ ì°¸ì¡° ì „ëµ**ì„ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤. ë©”ì¸ í”„ë¡œì„¸ìŠ¤ëŠ” ID, Typeë§Œ ì „ë‹¬í•˜ê³  ë Œë”ëŸ¬ëŠ” í•„ìš”í•œ ê²½ìš°ì— ë°ì´í„°ë¥¼ ìš”ì²­í•˜ê±°ë‚˜
  ìºì‹±ëœ ë°ì´í„°ë¥¼ ë°›ì•„ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ì„¤ê³„í•˜ì˜€ìŠµë‹ˆë‹¤.
  

#### React Query ê¸°ë°˜ ë°ì´í„° ìºì‹± ì „ëµ

ëŒ€í™”ë°©ì˜ ë©”ì‹œì§€ ë°ì´í„°ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ê´€ë¦¬í•˜ê¸° ìœ„í•´ **React Query**ë¥¼ í™œìš©í•œ ìºì‹± ë° ë¬´í•œ ìŠ¤í¬ë¡¤ì„ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

```mermaid
sequenceDiagram
    autonumber
    participant MyUI as My PC (UI)
    participant MyRQ as My PC (Cache)
    participant BE as Backend (API/WS)
    participant OtherRQ as Other PC (Cache)
    participant OtherUI as Other PC (UI)

    Note over MyUI, MyRQ: [ì†¡ì‹  ì¸¡] ë‚™ê´€ì  ì—…ë°ì´íŠ¸
    MyUI->>MyRQ: ë©”ì‹œì§€ ì „ì†¡ ìš”ì²­
    MyRQ->>MyRQ: Optimistic Update (UI ì¦‰ì‹œ ë°˜ì˜)
    MyRQ-->>MyUI: ì „ì†¡ ì¤‘ ìƒíƒœ í‘œì‹œ

    Note over MyRQ, BE: [ì„œë²„] ë°ì´í„° ì˜ì†í™”
    MyRQ->>BE: API ì „ì†¡ (HTTP POST)
    BE->>BE: DB ì €ì¥ ë° Sequence ë²ˆí˜¸ í• ë‹¹
    BE-->>MyRQ: ì‘ë‹µ (ì„œë²„ í™•ì • ë°ì´í„°)
    MyRQ->>MyRQ: ìºì‹œ ë°ì´í„° í™•ì • (Rollback/Update)

    Note over BE, OtherUI: [ìˆ˜ì‹  ì¸¡] ì‹¤ì‹œê°„ ë™ê¸°í™”
    BE->>OtherRQ: WebSocket ì´ë²¤íŠ¸ ë°œì†¡ (New Message)
    OtherRQ->>OtherRQ: setQueryData (ìºì‹œ ì¦‰ì‹œ ê°±ì‹ )
    OtherRQ-->>OtherUI: ìƒˆ ë©”ì‹œì§€ ë Œë”ë§
```



**ì„±ëŠ¥ ê°œì„  íš¨ê³¼**:
- **Instant Navigation**: ëŒ€í™”ë°© ì¬ì§„ì… ì‹œ ìºì‹œëœ ë°ì´í„° ì¦‰ì‹œ í‘œì‹œ â†’ UX ê°œì„ 
- **Optimistic Updates**: ë©”ì‹œì§€ ì „ì†¡ ì‹œ UI ì¦‰ì‹œ ë°˜ì˜ â†’ ë°˜ì‘ì„± í–¥ìƒ
- **Bidirectional Scroll**: í•„ìš”í•œ ë©”ì‹œì§€ë§Œ ì ì§„ì  ë¡œë“œ â†’ ì´ˆê¸° ë Œë”ë§ ì‹œê°„ ë‹¨ì¶•
- **Background Refetch**: ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìë™ ë™ê¸°í™” â†’ ìµœì‹  ìƒíƒœ ìœ ì§€

#### IPC ê¸°ë°˜ Electron ë¼ì´í”„ì‚¬ì´í´ ê´€ë¦¬

Electron í™˜ê²½ì—ì„œëŠ” **ë©”ì¸ í”„ë¡œì„¸ìŠ¤ì—ì„œ WebSocket ì—°ê²°ì„ ì¤‘ì•™ ê´€ë¦¬**í•˜ì—¬ ì—¬ëŸ¬ ì±„íŒ…ë°© ìœˆë„ìš°ê°€ ë‹¨ì¼ ì†Œì¼“ ì—°ê²°ì„ ê³µìœ í•˜ë„ë¡ ì„¤ê³„í–ˆìŠµë‹ˆë‹¤.<br />
- **ì±„íŒ…ì°½ ì†Œì¼“ í†µì‹  ê´€ë ¨ IPC íë¦„ë„**
```mermaid
sequenceDiagram
    participant R as Renderer Process
    participant M as Main Process
    participant S as Socket Manager
    participant API as Backend API

    Note over R,API: ì±„íŒ…ë°© ìœˆë„ìš° ì—´ê¸°
    R->>M: IPC: ìœˆë„ìš° ìƒì„± ìš”ì²­
    M->>M: BrowserWindow ìƒì„±
    M->>S: Socket join-room
    
    Note over R,API: ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬
    R->>M: IPC: ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸
    M->>S: Socket emit
    M->>API: ì½ìŒ ìƒíƒœ ë™ê¸°í™”
    
    Note over R,API: ì±„íŒ…ë°© ìœˆë„ìš° ë‹«ê¸°
    R->>M: ìœˆë„ìš° ì¢…ë£Œ ì´ë²¤íŠ¸
    M->>S: Socket leave-room
    M->>API: ìµœì¢… ì½ìŒ ìƒíƒœ ì €ì¥
    M->>M: ìœˆë„ìš° ë¦¬ì†ŒìŠ¤ ì •ë¦¬
```

**ê°œë°œìê°€ ìˆ˜ë™ìœ¼ë¡œ ìƒëª…ì£¼ê¸°ë¥¼ ê´€ë¦¬í•  í•„ìš” ì—†ì´** ìœˆë„ìš° ì´ë²¤íŠ¸ì— ë”°ë¼ ì†Œì¼“ ì—°ê²°ê³¼ ì½ìŒ ìƒíƒœê°€ ìë™ìœ¼ë¡œ ë™ê¸°í™”ë©ë‹ˆë‹¤. 

### 3-2. Backend

ë°±ì—”ë“œ ì•„í‚¤í…ì²˜ì—ì„œëŠ” **Clean Architecture ê¸°ë°˜ ê³„ì¸µ ë¶„ë¦¬**, **ì˜ì¡´ì„± ì£¼ì…ì„ í†µí•œ ìœ ì§€ë³´ìˆ˜ì„±**, **ë¹„ë™ê¸° ë©”ì‹œì§€ ì²˜ë¦¬**ë¥¼ í•µì‹¬ìœ¼ë¡œ ì„¤ê³„í–ˆìŠµë‹ˆë‹¤.

#### Clean Architecture + DDD ê¸°ë°˜ ê³„ì¸µ ë¶„ë¦¬

**ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ ì¸í”„ë¼ ê³„ì¸µì„ ì™„ì „íˆ ë¶„ë¦¬**í•˜ì—¬ í…ŒìŠ¤íŠ¸ ìš©ì´ì„±ê³¼ ìœ ì§€ë³´ìˆ˜ì„±ì„ í™•ë³´í–ˆìŠµë‹ˆë‹¤.

```mermaid
graph TB
    subgraph "API Layer"
        A[Fastify Routes<br/>REST API]
        B[WebSocket Server]
    end
    
    subgraph "Application Layer"
        C[Use Cases<br/>ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§]
    end
    
    subgraph "Domain Layer"
        D[Entities<br/>ë„ë©”ì¸ ëª¨ë¸]
        E[Value Objects<br/>ë„ë©”ì¸ ê·œì¹™]
    end
    
    subgraph "Infrastructure Layer"
        F[Repositories<br/>ë°ì´í„° ì ‘ê·¼]
        G[External Services<br/>ì™¸ë¶€ ì„œë¹„ìŠ¤]
    end
    
    subgraph "Data & Queue"
        H[(PostgreSQL<br/>Prisma)]
        I[Redis<br/>BullMQ]
    end
    
    A --> C
    B --> C
    C --> D
    C --> E
    C --> F
    C --> G
    F --> H
    F --> I
    G --> I
    
    style C fill:#4F46E5,color:#fff
    style D fill:#10B981,color:#fff
    style F fill:#F59E0B,color:#fff
```

**ê³„ì¸µ ê°„ ì˜ì¡´ì„±ì„ ì¸í„°í˜ì´ìŠ¤ë¡œ ì¶”ìƒí™”**í•˜ì—¬ ê° ê³„ì¸µì´ ë…ë¦½ì ìœ¼ë¡œ ë³€ê²½ ê°€ëŠ¥í•˜ë„ë¡ êµ¬ì„±í–ˆìŠµë‹ˆë‹¤.
- **Domain**: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§, ì—”í‹°í‹° ì •ì˜ (ì™¸ë¶€ ì˜ì¡´ì„± ì—†ìŒ)
- **Application**: Use Case êµ¬í˜„, ì„œë¹„ìŠ¤ ê³„ì¸µ
- **Infrastructure**: DB, Queue ë“± ì™¸ë¶€ ì„œë¹„ìŠ¤ êµ¬í˜„
- **API**: REST API, WebSocket ì—”ë“œí¬ì¸íŠ¸

#### Inversify ê¸°ë°˜ ì˜ì¡´ì„± ì£¼ì… (DI/IoC)

**Inversify IoC ì»¨í…Œì´ë„ˆ**ë¡œ ê³„ì¸µ ê°„ ì˜ì¡´ì„±ì„ ì—­ì „ì‹œì¼œ SOLID ì›ì¹™ì„ ì¤€ìˆ˜í–ˆìŠµë‹ˆë‹¤.

```typescript
// Lazy Proxy íŒ¨í„´ìœ¼ë¡œ í™˜ê²½ë³€ìˆ˜ ë¡œë”© ìˆœì„œ ë³´ì¥
export const container = new Proxy({} as AppContainer, {
  get(_target, prop) {
    return getContainer()[prop as keyof AppContainer];
  },
});

// ëª¨ë“ˆë³„ ì˜ì¡´ì„± ë“±ë¡ìœ¼ë¡œ ê´€ì‹¬ì‚¬ ë¶„ë¦¬
function createAppContainer(): AppContainer {
  const container = new Container({ defaultScope: 'Singleton' });
  registerDbModule(container);
  registerInfraModule(container, env);
  registerApplicationModule(container);
  return container;
}
```

**ì„¤ê³„ íš¨ê³¼**:
- **SOLID ì›ì¹™ ì¤€ìˆ˜**: ì˜ì¡´ì„± ì—­ì „ìœ¼ë¡œ ìƒìœ„ ê³„ì¸µì´ í•˜ìœ„ êµ¬í˜„ì— ì˜ì¡´í•˜ì§€ ì•ŠìŒ
- **í…ŒìŠ¤íŠ¸ ê°€ëŠ¥ì„±**: Mock ê°ì²´ ì£¼ì…ìœ¼ë¡œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‘ì„± ìš©ì´
- **ì‹±ê¸€í†¤ ê´€ë¦¬**: ì»¨í…Œì´ë„ˆê°€ ì„œë¹„ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ ìƒëª…ì£¼ê¸° ìë™ ê´€ë¦¬
- **í™˜ê²½ë³„ êµ¬ì„±**: ê°œë°œ/í”„ë¡œë•ì…˜ í™˜ê²½ë³„ ì„œë¹„ìŠ¤ êµ¬í˜„ êµì²´ ê°€ëŠ¥

```typescript
// ìœ ë‹› í…ŒìŠ¤íŠ¸ ë‹¨ìˆœí™”

// ì‹¤ êµ¬í˜„ë¶€
@injectable()
export class SendMessageUseCase {
  constructor(
    @inject(TYPES.MessageRepo) private messageRepo: IMessageRepo // ì¸í„°í˜ì´ìŠ¤ì— ì˜ì¡´
  ) {}

  async execute(content: string) {
    if (!content) throw new Error("ë‚´ìš© ë¹„ì–´ìˆìŒ");
    return await this.messageRepo.save(content);
  }
}

// í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤
it("DB ì—†ì´ë„ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥", async () => {
  const container = new Container();
  const mockRepo = { save: jest.fn().mockResolvedValue(true) };

  // ì‹¤ì œ DB ëŒ€ì‹  Mock ë°”ì¸ë”©
  container.bind<IMessageRepo>(TYPES.MessageRepo).toConstantValue(mockRepo);
  const useCase = container.resolve(SendMessageUseCase);

  const result = await useCase.execute("Hello");
  expect(result).toBe(true);
});
```

#### ì‹¤ì‹œê°„ ë©”ì‹œì§€ ì²˜ë¦¬ ì•„í‚¤í…ì²˜

**Fastify â†’ BullMQ â†’ Redis Pub/Sub â†’ WebSocket**ìœ¼ë¡œ ì´ì–´ì§€ëŠ” ë¹„ë™ê¸° íŒŒì´í”„ë¼ì¸ì„ êµ¬ì¶•í–ˆìŠµë‹ˆë‹¤.

```mermaid
sequenceDiagram
    participant C as Client
    participant API as Fastify API
    participant Q as Message Queue<br/>(BullMQ)
    participant W as Worker Process
    participant R as Redis Pub/Sub
    participant WS as WebSocket Server
    participant DB as PostgreSQL

    Note over C,DB: ë©”ì‹œì§€ ì „ì†¡ íë¦„
    C->>API: POST /message
    API->>Q: ë©”ì‹œì§€ enqueue
    API-->>C: 202 Accepted (ì¦‰ì‹œ ì‘ë‹µ)
    
    Q->>W: ë¹„ë™ê¸° ì²˜ë¦¬
    W->>DB: ë©”ì‹œì§€ ì €ì¥
    W->>R: publish('room:id', message)
    R->>WS: subscribe ì´ë²¤íŠ¸
    WS-->>C: WebSocketìœ¼ë¡œ ì‹¤ì‹œê°„ ì „ì†¡
```

**ë¹„ë™ê¸° ì²˜ë¦¬ ì „ëµ**:
- **BullMQ**: ë©”ì‹œì§€ íë¡œ ì¬ì‹œë„, ìš°ì„ ìˆœìœ„ ì²˜ë¦¬ ì§€ì›
- **Redis Pub/Sub**: ì—¬ëŸ¬ WebSocket ì„œë²„ ê°„ ì´ë²¤íŠ¸ ë¸Œë¡œë“œìºìŠ¤íŒ…
- **ì¦‰ì‹œ ì‘ë‹µ**: REST APIëŠ” 202 Acceptedë¥¼ ì¦‰ì‹œ ë°˜í™˜í•˜ê³  ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì²˜ë¦¬

#### Repository Patternìœ¼ë¡œ ë°ì´í„° ì ‘ê·¼ ì¶”ìƒí™”

**ê° featureë³„ Repository**ë¥¼ í†µí•´ ë„ë©”ì¸ë³„ ë°ì´í„° ê³„ì¸µì„ ë…ë¦½ì ìœ¼ë¡œ ê´€ë¦¬í–ˆìŠµë‹ˆë‹¤.

```typescript
// Application ê³„ì¸µì´ ì •ì˜í•œ ì¸í„°í˜ì´ìŠ¤ (ì˜ì¡´ì„± ì—­ì „)
interface MessageRepo {
  save(message: Message): Promise<void>;
  findByConversation(id: string, cursor?: Cursor): Promise<Message[]>;
}

// Infrastructure ê³„ì¸µì´ êµ¬í˜„
@injectable()
class MessageRepoImpl implements MessageRepo {
  constructor(private prisma: PrismaClient) {}
  // ... Prismaë¥¼ ì‚¬ìš©í•œ êµ¬í˜„
}
```

**ì¥ì **:
- **í…ŒìŠ¤íŠ¸ ìš©ì´ì„±**: Mock Repositoryë¡œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‘ì„±
- **êµ¬í˜„ êµì²´ ê°€ëŠ¥**: ORM êµì²´ ì‹œ Application ê³„ì¸µ ì˜í–¥ ì—†ìŒ
- **ê´€ì‹¬ì‚¬ ë¶„ë¦¬**: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ ë°ì´í„° ì €ì¥ ë°©ì‹ì— ë¬´ê´€

#### ì½ìŒ ìƒíƒœ ë™ê¸°í™” ì „ëµ (Redis + PostgreSQL)

**2-Tier Caching ì „ëµ**ìœ¼ë¡œ ì‹¤ì‹œê°„ ì„±ëŠ¥ê³¼ ë°ì´í„° ì •í•©ì„±ì„ ë™ì‹œì— ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤.

```mermaid
sequenceDiagram
    participant C as Client
    participant Redis as Redis Cache
    participant Sync as Sync Service<br/>(60ì´ˆ ì£¼ê¸°)
    participant DB as PostgreSQL

    Note over C,DB: ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸
    C->>Redis: ì½ìŒ ì´ë²¤íŠ¸
    Redis->>Redis: Dirty Flag ì„¤ì •
    
    Note over C,DB: ì´ˆê¸° ë¡œë“œ
    C->>Redis: ì½ìŒ ìƒíƒœ ì¡°íšŒ
    Redis-->>C: ìºì‹œëœ ë°ì´í„° (< 1ms)
    
    Note over C,DB: ì£¼ê¸°ì  ë™ê¸°í™”
    loop 60ì´ˆë§ˆë‹¤
        Sync->>Redis: Dirty Flag í™•ì¸
        Redis-->>Sync: ë³€ê²½ëœ ë°ì´í„°
        Sync->>DB: ë°°ì¹˜ ì—…ë°ì´íŠ¸
        Sync->>Redis: Dirty Flag ì´ˆê¸°í™”
    end
```

**ì „ëµ íš¨ê³¼**:
- **ì‹¤ì‹œê°„ ì„±ëŠ¥**: ì½ìŒ ìƒíƒœëŠ” Redisì—ì„œ ì¦‰ì‹œ ì½ê¸° (< 1ms)
- **DB ë¶€í•˜ ê°ì†Œ**: 60ì´ˆ ë°°ì¹˜ ë™ê¸°í™”ë¡œ ì“°ê¸° ì‘ì—… 90% ì´ìƒ ê°ì†Œ

**ğŸ” í•œê³„ì  ë° ê°œì„  ë°©ì•ˆ: Reliability vs Performance** <br />
í˜„ì¬ì˜ Write-Behind ì „ëµì€ ê·¹ì ì¸ ì„±ëŠ¥ í–¥ìƒì„ ê°€ì ¸ì™”ìœ¼ë‚˜, ì‹œìŠ¤í…œ ì¥ì•  ì‹œ ìµœëŒ€ 60ì´ˆ ë¶„ëŸ‰ì˜ ì½ìŒ ë°ì´í„° ìœ ì‹¤ ê°€ëŠ¥ì„±ì´ ì¡´ì¬í•©ë‹ˆë‹¤.

* **Trade-off ê²°ì • ê·¼ê±°**: ë©”ì‹ ì € ì„œë¹„ìŠ¤ì—ì„œ 'ì½ìŒ ìƒíƒœ'ëŠ” ë©”ì‹œì§€ ë³¸ë¬¸ë³´ë‹¤ ìƒëŒ€ì ìœ¼ë¡œ ë°ì´í„° ì¤‘ìš”ë„ê°€ ë‚®ë‹¤ê³  íŒë‹¨, ì‹œìŠ¤í…œ ê°€ìš©ì„±ê³¼ ì„±ëŠ¥ì„ ìœ„í•´ Eventual Consistency ëª¨ë¸ì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤.
* **ì°¨ê¸° ê°œì„ ì•ˆ**: 
    1. **Redis Streams ë„ì…**: Dirty Flag ë°©ì‹ì˜ ë ˆì´ìŠ¤ ì»¨ë””ì…˜ì„ í•´ê²°í•˜ê³  ì´ë²¤íŠ¸ ê¸°ë°˜ì˜ ì•ˆì •ì ì¸ ë™ê¸°í™” íŒŒì´í”„ë¼ì¸ êµ¬ì¶•.
    2. **Check-and-Set ì „ëµ**: DB ì—…ë°ì´íŠ¸ ì‹œ ì‹œí€€ìŠ¤ ë²ˆí˜¸ ë¹„êµ ë¡œì§ì„ ì¶”ê°€í•˜ì—¬ ë°ì´í„° ì—­ì „ í˜„ìƒ ë°©ì§€.

#### Prisma + Zod: ì»´íŒŒì¼íƒ€ì„ & ëŸ°íƒ€ì„ íƒ€ì… ì•ˆì „ì„±

**Prisma ORM**ê³¼ **Zod**ë¥¼ í†µí•©í•˜ì—¬ ì»´íŒŒì¼íƒ€ì„ê³¼ ëŸ°íƒ€ì„ ëª¨ë‘ì—ì„œ íƒ€ì… ì•ˆì „ì„±ì„ ë³´ì¥í–ˆìŠµë‹ˆë‹¤.

```mermaid
graph LR
    subgraph "Development"
        A[Prisma Schema] --> B[Prisma Client<br/>ì»´íŒŒì¼íƒ€ì„ íƒ€ì…]
        A --> C[Zod Schema<br/>ëŸ°íƒ€ì„ ê²€ì¦]
    end
    
    subgraph "API Layer"
        D[Client Request]
        E[Response]
    end
    
    subgraph "Validation Flow"
        F[Request DTO<br/>Zod ê²€ì¦]
        G[Business Logic<br/>Prisma íƒ€ì…]
        H[Database<br/>PostgreSQL]
    end
    
    D --> F
    C --> F
    F --> G
    B --> G
    G --> H
    H --> G
    G --> E
    
    style B fill:#4F46E5,color:#fff
    style C fill:#10B981,color:#fff
    style F fill:#F59E0B,color:#fff
```

**Prisma ìŠ¤í‚¤ë§ˆ ì„¤ê³„**:
```prisma
// ëŒ€í™”ë°© ë©¤ë²„ì™€ ì½ìŒ ìƒíƒœ
model ConversationMember {
  conversationId String
  pcId           String
  lastReadSeq    Int      @default(0)
  
  @@id([conversationId, pcId])
  @@index([conversationId, lastReadSeq])
}

// ë©”ì‹œì§€ seq ê´€ë¦¬ (ëŒ€í™”ë°©ë³„ auto-increment)
model Message {
  id             String @id @default(cuid())
  conversationId String
  seq            Int    // ëŒ€í™”ë°© ë‚´ ìˆœì„œ ë³´ì¥
  readCount      Int    @default(0)
  
  @@unique([conversationId, seq])
  @@index([conversationId, createdAt(sort: Desc)])
}
```

**Zod í†µí•© ì „ëµ**:
```typescript
// Prisma íƒ€ì…ì„ ê¸°ë°˜ìœ¼ë¡œ Zod ìŠ¤í‚¤ë§ˆ ìƒì„±
const CreateMessageSchema = z.object({
  conversationId: z.string().uuid(),
  content: z.string().min(1).max(5000),
  senderId: z.string(),
});

// API ìš”ì²­ ê²€ì¦
app.post('/message', async (req, res) => {
  // Query ë° BodyëŠ” fastify-type-provider-zodë¡œ fastify validator ë‹¨ê³„ì—ì„œ ê²€ì¦ 
  const validated = CreateMessageSchema.parse(req.body); // ëŸ°íƒ€ì„ ê²€ì¦
  const result = await messageRepo.save(validated); // Prisma íƒ€ì… ì•ˆì „ ì¿¼ë¦¬
  res.send(result);
});
```

**í†µí•© íš¨ê³¼**:
- **ì´ì¤‘ íƒ€ì… ì•ˆì „ì„±**: Prisma (ì»´íŒŒì¼íƒ€ì„) + Zod (ëŸ°íƒ€ì„) ì¡°í•©ìœ¼ë¡œ íƒ€ì… ì˜¤ë¥˜ ì‚¬ì „ ì°¨ë‹¨
- **ìë™ ê²€ì¦**: API ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ìš”ì²­/ì‘ë‹µ ìë™ ê²€ì¦
